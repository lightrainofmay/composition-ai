<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>ä½œæ–‡è¯†åˆ«ä¸æ™ºèƒ½è¯„æ”¹</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      padding: 20px;
    }

    .container {
      max-width: 960px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    h2 {
      color: #333;
    }

    .result-box {
      margin-top: 20px;
      background: #f9f9f9;
      padding: 15px;
      border-radius: 5px;
      white-space: pre-wrap;
    }

    button {
      font-size: 12px;
      padding: 5px 10px;
      margin-top: 10px;
      margin-right: 10px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 15px;
    }

    textarea,
    input[type="number"] {
      width: 100%;
      margin-top: 5px;
      font-size: 16px;
      padding: 10px;
    }

    input[type="number"] {
      width: 100px;
    }

    .progress-bar {
      height: 24px;
      background-color: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 20px;
    }

    .progress-bar-fill {
      height: 120%;
      width: 0%;
      background-color: #007bff;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: width 0.4s ease;
    }

    .button-group {
      display: flex;
      justify-content: flex-start;
      gap: 15px;
      margin-top: 10px;
    }

    .result-box div {
      line-height: 1.6;
    }

    .note {
      font-size: 14px;
      color: #555;
      margin-bottom: 10px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
  <div class="container">
    <h2>ä¸­å°å­¦ä½œæ–‡è¯†åˆ«ä¸è¯„æ”¹ç³»ç»Ÿ V1.0</h2>

    <label>ä¸Šä¼ æ‰‹å†™ä½œæ–‡å›¾ç‰‡ï¼š</label>
    <div class="note">ğŸ“Œè¯´æ˜ï¼šæ”¯æŒä¸Šä¼ ä¸€ä½å­¦ç”Ÿçš„å¤šé¡µä½œæ–‡ï¼ˆç‚¹å‡»â€œæäº¤å•ç¯‡/å¤šé¡µâ€ï¼‰ï¼Œæˆ–å¤šä½å­¦ç”Ÿçš„å•é¡µ/å¤šé¡µä½œæ–‡ï¼ˆç‚¹å‡»â€œæ‰¹é‡æäº¤â€ï¼‰ã€‚<br>
      ğŸ§  <b>æ‰¹é‡ä¸Šä¼ è¯·å°†åŒä¸€å­¦ç”Ÿçš„å›¾ç‰‡å‘½åä¸ºç›¸åŒå‰ç¼€</b>ï¼ˆå¦‚ <code>å¼ ä¸‰_1.jpg</code>ã€<code>å¼ ä¸‰_2.jpg</code>ï¼‰ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åˆ†ç»„è¯„æ”¹ã€‚</div>

    <input type="file" id="unified-file" accept="image/*" multiple>

    <div class="button-group">
      <button type="button" id="upload-single">æäº¤å•ç¯‡/å¤šé¡µ</button>
      <button type="button" id="upload-batch">æ‰¹é‡æäº¤</button>
    </div>

    <div class="progress-bar" id="progress-container" style="display:none;">
      <div class="progress-bar-fill" id="progress-fill">0%</div>
    </div>

    <div id="analysis-section" style="display:none;">
      <div class="result-box">
        <label>OCR è¯†åˆ«ç»“æœï¼š</label>
        <textarea id="ocr_text" rows="20" readonly></textarea>
        <label>OCR å‡†ç¡®æ€§è¯„åˆ†ï¼ˆ1-10ï¼‰ï¼š</label>
        <input type="number" id="score_ocr" min="1" max="10">
      </div>

      <div class="result-box">
        <label>ğŸ¤– GPT-4o æ™ºèƒ½è¯„è¯­ï¼š</label>
        <div id="gpt"></div>
        <label>GPT-4o è¯„åˆ†ï¼ˆ1-10ï¼‰ï¼š</label>
        <input type="number" id="score_gpt" min="1" max="10">
      </div>

      <div class="result-box">
        <label>ğŸŒˆ Gemini Flash æ™ºèƒ½è¯„è¯­ï¼š</label>
        <div id="gemini"></div>
        <label>Gemini Flash è¯„åˆ†ï¼ˆ1-10ï¼‰ï¼š</label>
        <input type="number" id="score_gemini" min="1" max="10">
      </div>

      <div class="result-box">
        <label>ğŸ§  DeepSeek Reasoner V3 æ™ºèƒ½è¯„è¯­ï¼š</label>
        <div id="deepseek"></div>
        <label>DeepSeek Reasoner è¯„åˆ†ï¼ˆ1-10ï¼‰ï¼š</label>
        <input type="number" id="score_deepseek" min="1" max="10">
      </div>

      <div class="result-box">
        <label>æ‚¨çš„æ€»ä½“è¯„ä»·æˆ–å»ºè®®ï¼š</label>
        <textarea id="user_comment" rows="10"></textarea>
        <div class="button-group">
          <button id="submit-feedback">æäº¤åé¦ˆ</button>
          <button id="download-csv">ä¸‹è½½åé¦ˆæ•°æ®</button>
        </div>
      </div>
    </div>

    <div id="batch-result"></div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const uploadSingleBtn = document.getElementById("upload-single");
      const batchBtn = document.getElementById("upload-batch");
      const progress = document.getElementById("progress-container");
      const progressFill = document.getElementById("progress-fill");
      const fileInput = document.getElementById("unified-file");
      const ocrTextArea = document.getElementById("ocr_text");
      const gptBox = document.getElementById("gpt");
      const geminiBox = document.getElementById("gemini");
      const deepseekBox = document.getElementById("deepseek");
      const analysisSection = document.getElementById("analysis-section");
      const feedbackBtn = document.getElementById("submit-feedback");
      const downloadBtn = document.getElementById("download-csv");
      const batchResultDiv = document.getElementById("batch-result");

      let latestResult = {};
      let startTime = new Date();

      function updateProgress(percent, label) {
        progress.style.display = "block";
        progressFill.style.width = percent + "%";
        progressFill.textContent = label;
      }

      uploadSingleBtn.addEventListener("click", async () => {
        if (!fileInput.files.length) return alert("è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€å¼ å›¾ç‰‡");
        startTime = new Date();
        updateProgress(10, "OCRä¸­...");
        const formData = new FormData();
        for (const file of fileInput.files) formData.append("file", file);

        const uploadRes = await fetch("/upload", { method: "POST", body: formData });
        const uploadData = await uploadRes.json();
        if (uploadData.error) return alert("ä¸Šä¼ å¤±è´¥: " + uploadData.error);

        ocrTextArea.value = uploadData.ocr_text;
        latestResult.ocr_text = uploadData.ocr_text;
        latestResult.ocr_score = uploadData.ocr_score;

        updateProgress(30, "ä½¿ç”¨ GPT-4o åˆ†æä¸­...");
        const gptRes = await fetch("/analyze_gpt", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: uploadData.ocr_text })
        });
        const gptData = await gptRes.json();
        gptBox.innerHTML = marked.parse(gptData.result || "æ— è¿”å›");
        latestResult.gpt_4o_feedback = gptData.result;
        latestResult.gpt_duration = gptData.duration || "";

        updateProgress(60, "ä½¿ç”¨ Gemini Flash åˆ†æä¸­...");
        const geminiRes = await fetch("/analyze_gemini", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: uploadData.ocr_text })
        });
        const geminiData = await geminiRes.json();
        geminiBox.innerHTML = marked.parse(geminiData.result || "æ— è¿”å›");
        latestResult.gemini_flash_feedback = geminiData.result;
        latestResult.gemini_duration = geminiData.duration || "";

        updateProgress(80, "ä½¿ç”¨ DeepSeek åˆ†æä¸­...");
        const deepRes = await fetch("/analyze_deepseek", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: uploadData.ocr_text })
        });
        const deepData = await deepRes.json();
        deepseekBox.innerHTML = marked.parse(deepData.result || "æ— è¿”å›");
        latestResult.deepseek_reasoner_feedback = deepData.result;
        latestResult.deepseek_duration = deepData.duration || "";

        updateProgress(100, "å…¨éƒ¨å®Œæˆâœ…");
        setTimeout(() => progress.style.display = "none", 800);
        analysisSection.style.display = "block";
      });

      batchBtn.addEventListener("click", async () => {
        if (!fileInput.files.length) return alert("è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶");
        const formData = new FormData();
        for (const file of fileInput.files) formData.append("files", file);

        updateProgress(10, `æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...`);
        const res = await fetch("/upload_batch_users", {
          method: "POST",
          body: formData,
        });

        updateProgress(60, "æ­£åœ¨åˆ†æï¼Œè¯·è€å¿ƒç­‰å¾…...");
        const data = await res.json();

        updateProgress(100, "åˆ†æå®Œæˆ âœ…");
        setTimeout(() => progress.style.display = "none", 1000);

        let html = '<div class="result-box"><h3>æ‰¹é‡æ‰¹æ”¹ç»“æœï¼š</h3>';
        data.results.forEach((item, idx) => {
          html += `<p><strong>ç¬¬ ${idx + 1} ä½ - ${item.student}</strong><br>${marked.parse(item.result)}</p><hr>`;
        });
        html += '</div>';
        batchResultDiv.innerHTML = html;
      });

      feedbackBtn.addEventListener("click", async () => {
        const feedbackData = {
          ...latestResult,
          score_ocr: document.getElementById("score_ocr").value || "",
          score_gpt: document.getElementById("score_gpt").value || "",
          score_gemini: document.getElementById("score_gemini").value || "",
          score_deepseek: document.getElementById("score_deepseek").value || "",
          user_comment: document.getElementById("user_comment").value,
          used_time: Math.round((new Date() - startTime) / 1000)
        };
        const res = await fetch("/submit_feedback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(feedbackData)
        });
        const result = await res.json();
        if (result.message) alert("âœ… åé¦ˆå·²ä¿å­˜ï¼Œè°¢è°¢ï¼");
        else alert("âŒ æäº¤å¤±è´¥: " + result.error);
      });

      downloadBtn.addEventListener("click", () => {
        window.location.href = "/download_feedback";
      });
    });
  </script>
</body>

</html>